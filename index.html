<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CheqControl Balance</title>
    
    <!-- ConfiguraciÃ³n PWA -->
    <meta name="theme-color" content="#1e40af">
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2534/2534860.png">

    <!-- LibrerÃ­as -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .accordion-content { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; overflow: hidden; }
        input, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    
    <div id="root"></div>

    <!-- Error Handler -->
    <div id="error-display" style="display:none; padding: 20px; background: #fee; color: #b00; border: 1px solid #b00; margin: 10px; border-radius: 5px; z-index:9999; position:relative;">
        <h3>Error de Carga</h3><pre id="error-message" style="font-size: 12px;"></pre>
    </div>
    <script>
        window.onerror = function(m,s,l,c,e){document.getElementById('error-display').style.display='block';document.getElementById('error-message').innerText=m+'\nL:'+l;};
        if('serviceWorker' in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(e=>console.log(e)));}
    </script>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAuEXUQT99SdJ1YZMhQOU-C0DGjQ1aIWXY",
            authDomain: "controlcheque-19226.firebaseapp.com",
            projectId: "controlcheque-19226",
            storageBucket: "controlcheque-19226.firebasestorage.app",
            messagingSenderId: "659933757076",
            appId: "1:659933757076:web:28d285726e6cb9560fbe81"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const { useState, useEffect, useMemo } = React;

        // --- ICONOS ---
        const IconCheck = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>;
        const IconTrash = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>;
        const IconPlus = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const IconLoader = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>;
        const IconChevronDown = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 12 15 18 9"/></svg>;
        const IconWallet = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>;
        const IconDownload = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const IconBriefcase = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>;
        const IconCash = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>;
        const IconTrendingUp = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>;
        const IconArrowUpRight = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="7" y1="17" x2="17" y2="7"/><polyline points="7 7 17 7 17 17"/></svg>;
        const IconArrowDownLeft = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="17" y1="7" x2="7" y2="17"/><polyline points="17 17 7 17 7 7"/></svg>;

        const CheqControl = () => {
            // ESTADOS
            const [mode, setMode] = useState('balance'); // 'pay', 'collect', 'balance' (Nuevo modo)
            
            // Datos Separados para facilitar el modo mixto
            const [payItems, setPayItems] = useState([]);
            const [collectItems, setCollectItems] = useState([]);
            
            const [loading, setLoading] = useState(true);
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            
            const [activeFilter, setActiveFilter] = useState('all'); 
            const [showAddForm, setShowAddForm] = useState(false);
            const [newItem, setNewItem] = useState({ 
                number: '', issueDate: '', dueDate: '', amount: '', payee: '', paidAmount: 0 
            });
            const [expandedDates, setExpandedDates] = useState({});

            // EFECTOS
            useEffect(() => {
                window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); setDeferredPrompt(e); });
                signInAnonymously(auth).catch(console.error);
            }, []);

            // CARGAR AMBAS COLECCIONES SIMULTANEAMENTE
            useEffect(() => {
                setLoading(true);
                
                // SuscripciÃ³n a Pagos
                const unsubPay = onSnapshot(collection(db, 'cheques_public_shared', 'main_list', 'items'), (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data(), type: 'pay' })); // Marcamos como pago
                    setPayItems(data);
                });

                // SuscripciÃ³n a Cobros
                const unsubCollect = onSnapshot(collection(db, 'cobros_public_shared', 'main_list', 'items'), (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data(), type: 'collect' })); // Marcamos como cobro
                    setCollectItems(data);
                });

                setLoading(false); // Aproximado, ya que son asÃ­ncronos
                return () => { unsubPay(); unsubCollect(); };
            }, []);

            // DATOS COMPUTADOS
            // Lista combinada o filtrada segÃºn el modo
            const displayedItems = useMemo(() => {
                let items = [];
                if (mode === 'pay') items = payItems;
                else if (mode === 'collect') items = collectItems;
                else items = [...payItems, ...collectItems]; // Modo Balance: Mezclar todo

                // Ordenar por fecha de vencimiento
                return items.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            }, [mode, payItems, collectItems]);

            // UTILS
            const getDays = (date) => Math.ceil((new Date(date+'T00:00:00') - new Date().setHours(0,0,0,0)) / (86400000));
            const formatMoney = (val) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 }).format(val);
            const formatDate = (dateStr) => {
                if(!dateStr) return '-';
                const date = new Date(dateStr + 'T00:00:00');
                return date.toLocaleDateString('es-AR', { weekday: 'short', day: 'numeric', month: 'short' });
            };

            // CALCULOS FINANCIEROS (BALANCE)
            const balanceData = useMemo(() => {
                const pendingPay = payItems
                    .filter(i => i.status !== 'paid')
                    .reduce((sum, i) => sum + (i.amount - (i.paidAmount || 0)), 0);
                
                const pendingCollect = collectItems
                    .filter(i => i.status !== 'paid')
                    .reduce((sum, i) => sum + (i.amount - (i.paidAmount || 0)), 0);

                return {
                    pay: pendingPay,
                    collect: pendingCollect,
                    net: pendingCollect - pendingPay
                };
            }, [payItems, collectItems]);

            // DASHBOARD DATA (Se adapta a la vista actual)
            const dashboardData = useMemo(() => {
                const pending = displayedItems.filter(i => i.status !== 'paid');
                const calcDebt = (list) => list.reduce((s, i) => s + (i.amount - (i.paidAmount || 0)), 0);
                
                return {
                    expired: { 
                        count: pending.filter(i => getDays(i.dueDate) < 0).length,
                        total: calcDebt(pending.filter(i => getDays(i.dueDate) < 0))
                    },
                    urgent: {
                        count: pending.filter(i => getDays(i.dueDate) >= 0 && getDays(i.dueDate) <= 7).length,
                        total: calcDebt(pending.filter(i => getDays(i.dueDate) >= 0 && getDays(i.dueDate) <= 7))
                    },
                    future: {
                        count: pending.filter(i => getDays(i.dueDate) > 7).length,
                        total: calcDebt(pending.filter(i => getDays(i.dueDate) > 7))
                    }
                };
            }, [displayedItems]);

            // VISTA AGRUPADA (LÃ³gica de filtrado visual)
            const groupedView = useMemo(() => {
                let filtered = displayedItems;
                if (activeFilter !== 'all') {
                    filtered = displayedItems.filter(i => {
                        if (i.status === 'paid') return false;
                        const d = getDays(i.dueDate);
                        if (activeFilter === 'expired') return d < 0;
                        if (activeFilter === 'urgent') return d >= 0 && d <= 7;
                        if (activeFilter === 'future') return d > 7;
                        return true;
                    });
                }

                if (activeFilter === 'all') return { type: 'flat', data: filtered };

                const groups = {};
                filtered.forEach(item => {
                    const dateKey = item.dueDate;
                    if (!groups[dateKey]) groups[dateKey] = { date: dateKey, total: 0, items: [] };
                    // Sumamos algebraicamente: Cobros suman, Pagos restan (Solo para visualizaciÃ³n)
                    // O mejor, sumamos volumen absoluto para saber movimiento del dÃ­a
                    groups[dateKey].total += (item.amount - (item.paidAmount || 0)); 
                    groups[dateKey].items.push(item);
                });
                return { type: 'grouped', data: Object.values(groups).sort((a,b) => new Date(a.date) - new Date(b.date)) };
            }, [displayedItems, activeFilter]);

            // ACCIONES
            const handleAdd = async (e) => {
                e.preventDefault();
                // LÃ³gica de formulario
                // NOTA: El form ahora tiene un selector interno
                const isCollect = document.getElementById('typeSelector')?.value === 'collect';
                const targetCollection = isCollect ? 'cobros_public_shared' : 'cheques_public_shared';

                await addDoc(collection(db, targetCollection, 'main_list', 'items'), {
                    ...newItem, 
                    amount: parseFloat(newItem.amount), 
                    paidAmount: 0,
                    status: 'pending', 
                    createdAt: new Date().toISOString()
                });
                setNewItem({ number: '', issueDate: '', dueDate: '', amount: '', payee: '', paidAmount: 0 });
                setShowAddForm(false);
            };

            const markFullPayment = async (item) => {
                const collectionName = item.type === 'collect' ? 'cobros_public_shared' : 'cheques_public_shared';
                const newStatus = item.status === 'paid' ? 'pending' : 'paid';
                const newPaidAmount = newStatus === 'paid' ? item.amount : 0;
                
                await updateDoc(doc(db, collectionName, 'main_list', 'items', item.id), { 
                    status: newStatus,
                    paidAmount: newPaidAmount
                });
            };

            const markPartialPayment = async (item) => {
                const amountStr = prompt(`Importe Total: ${item.amount}\nPagado hasta ahora: ${item.paidAmount || 0}\n\nIngrese monto acumulado Total:`);
                if(!amountStr) return;
                const totalPaid = parseFloat(amountStr);
                if(isNaN(totalPaid)) return alert("Monto invÃ¡lido");

                // Determinar estado
                let newStatus = 'pending';
                if(totalPaid >= item.amount) newStatus = 'paid';
                else if(totalPaid > 0) newStatus = 'partial';

                const collectionName = item.type === 'collect' ? 'cobros_public_shared' : 'cheques_public_shared';
                await updateDoc(doc(db, collectionName, 'main_list', 'items', item.id), { 
                    status: newStatus,
                    paidAmount: totalPaid >= item.amount ? item.amount : totalPaid
                });
            };

            const deleteItem = async (item) => {
                if(!confirm('Â¿Eliminar permanentemente?')) return;
                const collectionName = item.type === 'collect' ? 'cobros_public_shared' : 'cheques_public_shared';
                await deleteDoc(doc(db, collectionName, 'main_list', 'items', item.id));
            };

            const installApp = () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((res) => { if(res.outcome==='accepted') setDeferredPrompt(null); });
                }
            };

            // COLORES DE TEMA DINAMICOS
            const getTheme = () => {
                if(mode === 'pay') return { main: 'blue', bg: 'bg-blue-800', light: 'bg-blue-50', text: 'text-blue-600', border: 'border-blue-500', btn: 'bg-blue-600' };
                if(mode === 'collect') return { main: 'emerald', bg: 'bg-emerald-800', light: 'bg-emerald-50', text: 'text-emerald-600', border: 'border-emerald-500', btn: 'bg-emerald-600' };
                return { main: 'violet', bg: 'bg-violet-900', light: 'bg-violet-50', text: 'text-violet-600', border: 'border-violet-500', btn: 'bg-violet-600' }; // Balance
            }
            const theme = getTheme();

            // CORRECCIÃ“N: Usar payItems y collectItems en lugar de 'items' que no existe
            if (loading && payItems.length === 0 && collectItems.length === 0) return <div className="h-screen flex items-center justify-center"><IconLoader className={`animate-spin w-10 h-10 ${theme.text}`}/></div>;

            return (
                <div className="pb-24 max-w-4xl mx-auto min-h-screen bg-gray-50 shadow-2xl relative transition-colors duration-500">
                    
                    {/* --- HEADER --- */}
                    <div className={`${theme.bg} text-white p-4 sticky top-0 z-30 shadow-lg transition-colors duration-500`}>
                        <div className="flex justify-between items-center mb-4">
                            <h1 className="text-xl font-bold flex items-center gap-2">CheqControl</h1>
                            {deferredPrompt && (
                                <button onClick={installApp} className="bg-white/20 hover:bg-white/30 px-2 py-1 rounded text-xs font-bold flex items-center gap-1">
                                    <IconDownload className="w-4 h-4" /> Instalar
                                </button>
                            )}
                        </div>

                        {/* SELECTOR DE 3 ESTADOS */}
                        <div className="bg-black/20 p-1 rounded-xl flex relative text-[10px] sm:text-xs">
                            <button onClick={() => { setMode('pay'); setActiveFilter('all'); }} className={`flex-1 py-2 rounded-lg font-bold flex flex-col sm:flex-row items-center justify-center gap-1 transition-all ${mode === 'pay' ? 'bg-white text-blue-800 shadow-md' : 'text-white/60'}`}>
                                <IconWallet className="w-4 h-4"/> <span>PAGOS</span>
                            </button>
                            <button onClick={() => { setMode('balance'); setActiveFilter('all'); }} className={`flex-1 py-2 rounded-lg font-bold flex flex-col sm:flex-row items-center justify-center gap-1 transition-all ${mode === 'balance' ? 'bg-white text-violet-800 shadow-md' : 'text-white/60'}`}>
                                <IconTrendingUp className="w-4 h-4"/> <span>BALANCE</span>
                            </button>
                            <button onClick={() => { setMode('collect'); setActiveFilter('all'); }} className={`flex-1 py-2 rounded-lg font-bold flex flex-col sm:flex-row items-center justify-center gap-1 transition-all ${mode === 'collect' ? 'bg-white text-emerald-800 shadow-md' : 'text-white/60'}`}>
                                <IconBriefcase className="w-4 h-4"/> <span>COBROS</span>
                            </button>
                        </div>
                    </div>

                    <div className="p-4">
                        
                        {/* --- TOTAL CARD (INTELIGENTE) --- */}
                        <div className={`bg-white p-4 rounded-2xl shadow-md border-l-8 mb-6 ${theme.border}`}>
                            {mode === 'balance' ? (
                                <div>
                                    <p className="text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">Flujo de Caja Proyectado</p>
                                    <div className="flex justify-between items-end mb-2">
                                        <div>
                                            <p className="text-[10px] text-emerald-600 font-bold mb-0.5">A COBRAR (+)</p>
                                            <p className="text-lg font-bold text-gray-700">{formatMoney(balanceData.collect)}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-[10px] text-blue-600 font-bold mb-0.5">A PAGAR (-)</p>
                                            <p className="text-lg font-bold text-gray-700">{formatMoney(balanceData.pay)}</p>
                                        </div>
                                    </div>
                                    <div className="border-t pt-2 flex justify-between items-center">
                                        <span className="text-xs font-bold text-gray-500">SALDO NETO:</span>
                                        <span className={`text-2xl font-black ${balanceData.net >= 0 ? 'text-emerald-500' : 'text-red-500'}`}>
                                            {formatMoney(balanceData.net)}
                                        </span>
                                    </div>
                                </div>
                            ) : (
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className={`text-xs font-bold uppercase tracking-wide mb-1 ${theme.text}`}>
                                            {mode === 'pay' ? 'Deuda Total' : 'Cobro Total Pendiente'}
                                        </p>
                                        <p className="text-3xl font-black text-gray-800">
                                            {mode === 'pay' ? formatMoney(balanceData.pay) : formatMoney(balanceData.collect)}
                                        </p>
                                    </div>
                                    <div className={`${theme.light} p-3 rounded-full`}>
                                        {mode === 'pay' ? <IconWallet className={`w-8 h-8 ${theme.text}`} /> : <IconCash className={`w-8 h-8 ${theme.text}`} />}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* --- DASHBOARD --- */}
                        <div className="grid grid-cols-3 gap-2 mb-6">
                            {[
                                { id: 'expired', label: 'Vencidos', color: 'red', data: dashboardData.expired },
                                { id: 'urgent', label: 'Esta Semana', color: 'orange', data: dashboardData.urgent },
                                { id: 'future', label: 'A Futuro', color: 'green', data: dashboardData.future }
                            ].map(filter => (
                                <button key={filter.id} onClick={() => setActiveFilter(activeFilter === filter.id ? 'all' : filter.id)} className={`p-2 rounded-xl border-2 transition-all text-center flex flex-col items-center justify-center shadow-sm relative ${activeFilter === filter.id ? `bg-${filter.color}-50 border-${filter.color}-500 ring-2 ring-${filter.color}-200` : 'bg-white border-transparent hover:bg-gray-50'}`}>
                                    <span className={`text-[10px] font-bold text-${filter.color}-600 uppercase`}>{filter.label}</span>
                                    <span className="text-lg font-black text-gray-800 leading-tight">{filter.data.count}</span>
                                    <span className="text-[9px] text-gray-500 truncate w-full">{formatMoney(filter.data.total)}</span>
                                    {activeFilter === filter.id && <div className={`absolute -bottom-2 w-3 h-3 bg-${filter.color}-500 rotate-45 border-r border-b border-white`}></div>}
                                </button>
                            ))}
                        </div>

                        {/* --- BOTON AGREGAR --- */}
                        <button onClick={() => setShowAddForm(!showAddForm)} className={`w-full ${theme.btn} hover:opacity-90 text-white p-3 rounded-xl shadow-md mb-6 flex items-center justify-center gap-2 font-bold transition-all active:scale-95`}>
                            <IconPlus className="w-5 h-5"/> {showAddForm ? 'Cancelar' : 'Agregar Movimiento'}
                        </button>

                        {/* --- FORMULARIO --- */}
                        {showAddForm && (
                            <form onSubmit={handleAdd} className="bg-white p-5 rounded-xl shadow-lg border border-gray-200 mb-6 animate-fade-in relative overflow-hidden">
                                <div className={`absolute top-0 left-0 w-1 h-full ${theme.bg}`}></div>
                                <h3 className="font-bold mb-4 text-gray-700">Nuevo Movimiento</h3>
                                
                                {/* Selector Interno de Tipo (Solo visible si es modo Balance o para cambiar rÃ¡pido) */}
                                <div className="mb-4">
                                    <select id="typeSelector" className="w-full p-2 bg-gray-100 rounded-lg border font-bold text-sm outline-none" defaultValue={mode === 'collect' ? 'collect' : 'pay'}>
                                        <option value="pay">ðŸ”´ Registrar PAGO (Cheque)</option>
                                        <option value="collect">ðŸŸ¢ Registrar COBRO (Cliente)</option>
                                    </select>
                                </div>

                                <div className="space-y-3">
                                    <input className="w-full p-3 bg-gray-50 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Beneficiario / Cliente" value={newItem.payee} onChange={e=>setNewItem({...newItem, payee:e.target.value})} required />
                                    <div className="flex gap-3">
                                        <input className="w-1/2 p-3 bg-gray-50 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none" placeholder="NÂº Doc" value={newItem.number} onChange={e=>setNewItem({...newItem, number:e.target.value})} required />
                                        <input type="number" step="0.01" className="w-1/2 p-3 bg-gray-50 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none" placeholder="$ Importe" value={newItem.amount} onChange={e=>setNewItem({...newItem, amount:e.target.value})} required />
                                    </div>
                                    <div className="flex gap-3">
                                        <div className="w-1/2">
                                            <label className="text-xs text-gray-500 block mb-1">EmisiÃ³n</label>
                                            <input type="date" className="w-full p-3 bg-gray-50 rounded-lg border outline-none" value={newItem.issueDate} onChange={e=>setNewItem({...newItem, issueDate:e.target.value})} />
                                        </div>
                                        <div className="w-1/2">
                                            <label className="text-xs text-gray-500 block mb-1 font-bold">Vencimiento</label>
                                            <input type="date" className="w-full p-3 bg-gray-50 rounded-lg border outline-none font-bold text-gray-700" value={newItem.dueDate} onChange={e=>setNewItem({...newItem, dueDate:e.target.value})} required />
                                        </div>
                                    </div>
                                    <button type="submit" className={`w-full ${theme.btn} text-white p-3 rounded-lg font-bold hover:opacity-90`}>Guardar</button>
                                </div>
                            </form>
                        )}

                        {/* --- LISTA --- */}
                        <div className="flex justify-between items-end mb-4 border-b pb-2">
                            <h2 className="text-lg font-bold text-gray-700">
                                {activeFilter === 'all' ? 'Movimientos' : 'Filtrado'}
                            </h2>
                            {activeFilter !== 'all' && <button onClick={() => setActiveFilter('all')} className={`text-xs ${theme.text} font-bold underline`}>Ver Todo</button>}
                        </div>

                        <div className="space-y-3">
                            {/* RENDER ITEM */}
                            {(() => {
                                const renderItem = (item) => {
                                    const days = getDays(item.dueDate);
                                    const isPaid = item.status === 'paid';
                                    const isPartial = item.status === 'partial';
                                    const isCollect = item.type === 'collect';
                                    
                                    // Borde de estado (Tiempo)
                                    let borderClass = 'border-l-4 ';
                                    if (isPaid) borderClass += 'border-gray-300 bg-gray-50 opacity-60';
                                    else if (isPartial) borderClass += 'border-yellow-400 bg-yellow-50';
                                    else if (days < 0) borderClass += 'border-red-500 bg-red-50';
                                    else if (days <= 7) borderClass += 'border-orange-400 bg-orange-50';
                                    else borderClass += 'border-green-400 bg-white';

                                    // Icono de tipo de movimiento (Flecha roja o verde)
                                    const TypeIcon = isCollect ? IconArrowDownLeft : IconArrowUpRight;
                                    const typeColor = isCollect ? 'text-emerald-600 bg-emerald-100' : 'text-blue-600 bg-blue-100';

                                    return (
                                        <div key={item.id} className={`p-4 rounded-lg shadow-sm flex flex-col sm:flex-row gap-2 justify-between items-start sm:items-center ${borderClass} mb-2`}>
                                            <div className="flex-1 min-w-0 flex items-start gap-3">
                                                <div className={`p-2 rounded-full ${typeColor} mt-1 shrink-0`}>
                                                    <TypeIcon className="w-4 h-4" />
                                                </div>
                                                <div className="min-w-0">
                                                    <div className="flex items-center gap-2">
                                                        <h3 className={`font-bold truncate ${isPaid ? 'line-through text-gray-500' : 'text-gray-800'}`}>{item.payee}</h3>
                                                        {isPartial && <span className="bg-yellow-200 text-yellow-800 text-[9px] px-1 rounded font-bold">PARCIAL</span>}
                                                    </div>
                                                    <div className="text-xs text-gray-500 flex flex-wrap gap-2 mt-1">
                                                        <span className="font-mono bg-white px-1 rounded border">#{item.number}</span>
                                                        <span>â€¢</span>
                                                        <span className={days < 0 && !isPaid ? 'text-red-600 font-bold' : ''}>Vence: {formatDate(item.dueDate)}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div className="w-full sm:w-auto flex justify-between sm:justify-end items-center gap-4 pl-0 sm:pl-3 border-t sm:border-t-0 pt-2 sm:pt-0 mt-2 sm:mt-0">
                                                <div className="text-right">
                                                    <div className={`font-bold text-lg ${isCollect ? 'text-emerald-700' : 'text-blue-800'}`}>
                                                        {isCollect ? '+' : '-'}{formatMoney(item.amount)}
                                                    </div>
                                                    {(isPartial || (isPaid && item.paidAmount < item.amount)) && (
                                                        <div className="text-[10px] text-red-500 font-bold">
                                                            Resta: {formatMoney(item.amount - (item.paidAmount || 0))}
                                                        </div>
                                                    )}
                                                </div>
                                                
                                                <div className="flex gap-1">
                                                    <button onClick={() => markFullPayment(item)} className={`p-1.5 rounded border shadow-sm ${isPaid ? 'bg-green-100 text-green-700 border-green-300' : 'bg-white text-gray-400 hover:text-green-600'}`}>
                                                        <IconCheck className="w-4 h-4"/>
                                                    </button>
                                                    {!isPaid && (
                                                        <button onClick={() => markPartialPayment(item)} className="p-1.5 rounded border shadow-sm bg-white text-gray-400 hover:text-yellow-600 hover:bg-yellow-50">
                                                            <span className="font-bold text-xs w-4 h-4 flex items-center justify-center">$</span>
                                                        </button>
                                                    )}
                                                    <button onClick={() => deleteItem(item)} className="p-1.5 rounded border shadow-sm bg-white text-gray-400 hover:text-red-600 hover:bg-red-50">
                                                        <IconTrash className="w-4 h-4"/>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                };

                                if (groupedView.type === 'flat') {
                                    if(groupedView.data.length === 0) return <div className="text-center py-10 text-gray-400 italic">No hay registros.</div>;
                                    return groupedView.data.map(renderItem);
                                } else {
                                    if(groupedView.data.length === 0) return <div className="text-center py-10 text-gray-400 italic">No hay registros.</div>;
                                    return groupedView.data.map((group, idx) => (
                                        <div key={idx} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-2">
                                            <button onClick={() => setExpandedDates(p => ({...p, [group.date]: !p[group.date]}))} className="w-full p-3 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition">
                                                <div className="flex items-center gap-3">
                                                    <div className={`${theme.light} ${theme.text} font-bold rounded-lg p-2 text-center min-w-[50px]`}>
                                                        <span className="block text-xs uppercase">{new Date(group.date + 'T00:00:00').toLocaleDateString('es-AR', {month:'short'})}</span>
                                                        <span className="block text-xl leading-none">{new Date(group.date + 'T00:00:00').getDate()}</span>
                                                    </div>
                                                    <div className="text-left"><p className="text-sm font-bold text-gray-700">{group.items.length} Items</p></div>
                                                </div>
                                                <div className="text-right">
                                                    <IconChevronDown className={`w-5 h-5 ml-auto text-gray-400 transition-transform ${expandedDates[group.date] ? 'rotate-180' : ''}`} />
                                                </div>
                                            </button>
                                            {expandedDates[group.date] && <div className="border-t border-gray-100 animate-fade-in bg-white p-2">{group.items.map(renderItem)}</div>}
                                        </div>
                                    ));
                                }
                            })()}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CheqControl />);
    </script>
</body>
</html>

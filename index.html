<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SII PALLETS APP</title>
    
    <!-- Configuración PWA -->
    <meta name="theme-color" content="#1e40af">
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SII PALLETS">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png">

    <!-- Librerías -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .accordion-content { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; overflow: hidden; }
        input, select, textarea { font-size: 16px !important; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    
    <div id="root"></div>

    <!-- Error Handler -->
    <div id="error-display" style="display:none; padding: 20px; background: #fee; color: #b00; border: 1px solid #b00; margin: 10px; border-radius: 5px; z-index:9999; position:relative;">
        <h3>Error de Carga</h3><pre id="error-message" style="font-size: 12px;"></pre>
    </div>
    <script>
        window.onerror = function(m,s,l,c,e){document.getElementById('error-display').style.display='block';document.getElementById('error-message').innerText=m+'\nL:'+l;};
        if('serviceWorker' in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(e=>console.log(e)));}
    </script>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAuEXUQT99SdJ1YZMhQOU-C0DGjQ1aIWXY",
            authDomain: "controlcheque-19226.firebaseapp.com",
            projectId: "controlcheque-19226",
            storageBucket: "controlcheque-19226.firebasestorage.app",
            messagingSenderId: "659933757076",
            appId: "1:659933757076:web:28d285726e6cb9560fbe81"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const { useState, useEffect, useMemo } = React;

        // --- ICONOS ---
        const IconCheck = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>;
        const IconTrash = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>;
        const IconPlus = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const IconLoader = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>;
        const IconChevronDown = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 12 15 18 9"/></svg>;
        const IconWallet = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>;
        const IconDownload = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const IconBriefcase = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>;
        const IconCash = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>;
        const IconTrendingUp = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>;
        const IconArrowUpRight = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="7" y1="17" x2="17" y2="7"/><polyline points="7 7 17 7 17 17"/></svg>;
        const IconArrowDownLeft = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="17" y1="7" x2="7" y2="17"/><polyline points="17 17 7 17 7 7"/></svg>;
        const IconUserGroup = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const IconBell = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>;
        const IconBellRing = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/><path d="M4 2C2.8 3.7 2 5.7 2 8"/><path d="M22 8c0-2.3-.8-4.3-2-6"/></svg>;
        const IconBank = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M12 12a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M2 10h20"/></svg>;
        const IconBuilding = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 22V12c0-1.1.9-2 2-2h8a2 2 0 0 1 2 2v10H6Z"/><path d="M6 18H4a2 2 0 0 1-2-2v-5.5a2 2 0 0 1 2-2h2"/><path d="M18 18h2a2 2 0 0 0 2-2v-5.5a2 2 0 0 0-2-2h-2"/><path d="M12 6V2"/><path d="M12 2L7 7"/><path d="M12 2l5 5"/></svg>;
        const IconPieChart = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>;
        const IconPencil = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;
        const IconPrinter = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>;
        const IconSearch = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>;
        const IconCalendar = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;

        const CheqControl = () => {
            const [mode, setMode] = useState('pay'); 
            const [payItems, setPayItems] = useState([]);
            const [collectItems, setCollectItems] = useState([]);
            const [loading, setLoading] = useState(true);
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [activeFilter, setActiveFilter] = useState('all'); 
            const [showAddForm, setShowAddForm] = useState(false);
            const [newItem, setNewItem] = useState({ 
                number: '', issueDate: '', dueDate: '', amount: '', payee: '', paidAmount: 0, subtype: 'cheque', category: 'others', status: 'pending'
            });
            const [editingId, setEditingId] = useState(null); 
            const [expandedGroups, setExpandedGroups] = useState({});
            const [expandedCategory, setExpandedCategory] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");
            const [showNotifPanel, setShowNotifPanel] = useState(false);
            const [notifPermission, setNotifPermission] = useState(typeof Notification !== 'undefined' ? Notification.permission : 'default');
            const [selectedDateFilter, setSelectedDateFilter] = useState(null);

            useEffect(() => {
                window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); setDeferredPrompt(e); });
                signInAnonymously(auth).catch(console.error);
            }, []);

            useEffect(() => {
                setLoading(true);
                const unsubPay = onSnapshot(collection(db, 'cheques_public_shared', 'main_list', 'items'), (snap) => {
                    const data = snap.docs.map(d => {
                        const dat = d.data();
                        return { id: d.id, ...dat, dueDate: dat.dueDate || dat.date, type: 'pay', subtype: dat.subtype || 'cheque', category: dat.category || 'others' };
                    });
                    setPayItems(data);
                    checkAlerts([...data, ...collectItems]);
                });

                const unsubCollect = onSnapshot(collection(db, 'cobros_public_shared', 'main_list', 'items'), (snap) => {
                    const data = snap.docs.map(d => {
                        const dat = d.data();
                        return { id: d.id, ...dat, dueDate: dat.dueDate || dat.date, type: 'collect', subtype: dat.subtype || 'invoice' };
                    });
                    setCollectItems(data);
                    checkAlerts([...payItems, ...data]);
                });

                setTimeout(() => setLoading(false), 800); 
                return () => { unsubPay(); unsubCollect(); };
            }, []);

            const getDays = (date) => { if (!date) return 999; return Math.ceil((new Date(date+'T00:00:00') - new Date().setHours(0,0,0,0)) / (86400000)); };
            const formatMoney = (val) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 }).format(val);
            const formatDate = (dateStr) => { if(!dateStr) return '-'; const date = new Date(dateStr + 'T00:00:00'); return date.toLocaleDateString('es-AR', { weekday: 'short', day: 'numeric', month: 'short' }); };

            const uniqueClients = useMemo(() => {
                const clients = new Set();
                collectItems.forEach(item => { if(item.payee) clients.add(item.payee.trim()); });
                return Array.from(clients).sort();
            }, [collectItems]);

            const getCategoryLabel = (cat) => {
                const map = { 'raw': 'Materia Prima', 'logistics': 'Logística', 'taxes': 'Impuestos', 'salaries': 'Sueldos', 'services': 'Servicios', 'maintenance': 'Mantenimiento', 'others': 'Otros' };
                return map[cat] || 'Otros';
            };

            const getCategoryColor = (cat) => {
                const map = { 'raw': 'bg-blue-500', 'logistics': 'bg-orange-500', 'taxes': 'bg-red-500', 'salaries': 'bg-green-500', 'services': 'bg-purple-500', 'maintenance': 'bg-yellow-500', 'others': 'bg-gray-400' };
                return map[cat] || 'bg-gray-400';
            };

            const printReport = () => {
                if (!groupedView || !groupedView.data || groupedView.data.length === 0) return alert("No hay datos para imprimir.");

                let contentHTML = `
                    <html>
                    <head>
                        <title>Reporte SII PALLETS</title>
                        <style>
                            body { font-family: sans-serif; padding: 20px; color: #333; font-size: 11px; }
                            h1 { color: #1e40af; border-bottom: 2px solid #1e40af; padding-bottom: 5px; font-size: 16px; margin-bottom: 5px; }
                            .meta { color: #666; font-size: 9px; margin-bottom: 10px; }
                            
                            table { width: 100%; border-collapse: collapse; margin-top: 5px; }
                            th { background: #f3f4f6; padding: 4px; text-align: left; font-size: 10px; border-bottom: 1px solid #999; font-weight: bold; }
                            td { padding: 3px 4px; border-bottom: 1px solid #eee; vertical-align: top; }
                            .group-row td { background: #e5e7eb; font-weight: bold; padding: 4px; font-size: 11px; border-top: 1px solid #ccc; }
                            .amount { font-family: monospace; text-align: right; }
                            .date { white-space: nowrap; }
                            .red { color: #dc2626; font-weight: bold; }
                            .green { color: #16a34a; font-weight: bold; }
                            
                            .total-box { padding: 8px; background: #f0f9ff; border: 1px solid #bae6fd; margin-bottom: 10px; border-radius: 4px; font-weight: bold; font-size: 12px; }
                            
                            @media print { button { display: none; } }
                        </style>
                    </head>
                    <body>
                        <h1>Reporte de ${mode === 'pay' ? 'Pagos' : (mode === 'collect' ? 'Cobros' : 'Balance')}</h1>
                        <p class="meta">Generado: ${new Date().toLocaleDateString('es-AR')} • SII PALLETS APP</p>
                `;

                if (mode === 'balance') {
                    contentHTML += `
                        <div class="total-box">
                            Neto Proyectado: ${formatMoney(balanceData.net)}
                        </div>
                        <table>
                            <thead><tr><th>Fecha</th><th style="text-align:right">Entradas</th><th style="text-align:right">Salidas</th><th style="text-align:right">Neto</th></tr></thead>
                            <tbody>
                    `;
                    balanceData.dailyAgenda.forEach(day => {
                        contentHTML += `
                            <tr>
                                <td>${new Date(day.date + 'T00:00:00').toLocaleDateString('es-AR')}</td>
                                <td class="amount green">${day.inflow > 0 ? formatMoney(day.inflow) : '-'}</td>
                                <td class="amount" style="color:blue">${day.outflow > 0 ? formatMoney(day.outflow) : '-'}</td>
                                <td class="amount">${formatMoney(day.net)}</td>
                            </tr>
                        `;
                    });
                    contentHTML += `</tbody></table>`;
                } else {
                    const modeTotal = mode === 'pay' ? balanceData.pay : balanceData.collect;
                    contentHTML += `
                        <div class="total-box">Total Pendiente: ${formatMoney(modeTotal)}</div>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:30%">Referencia</th>
                                    <th style="width:15%">Vencimiento</th>
                                    <th style="text-align:right;width:15%">Total</th>
                                    <th style="text-align:right;width:20%">Pendiente</th>
                                    <th style="text-align:right;width:20%">Acumulado</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    let runningAccumulator = 0;

                    groupedView.data.forEach(group => {
                        let groupTitle = '';
                        if (groupedView.type === 'client-grouped') {
                            groupTitle = group.label;
                            runningAccumulator = 0; // Reset for each client
                        } else {
                             groupTitle = new Date(group.key + 'T00:00:00').toLocaleDateString('es-AR');
                        }

                        // Ordenar items cronológicamente para la impresión
                        const sortedItems = [...group.items].sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

                        contentHTML += `<tr class="group-row"><td colspan="2">${groupTitle}</td><td class="amount" colspan="3">Grupo: ${formatMoney(group.total)}</td></tr>`;
                        
                        sortedItems.forEach(item => {
                            const details = item.number ? `Ref: ${item.number}` : '';
                            const remaining = item.amount - (item.paidAmount||0);
                            const isPaid = item.status === 'paid';
                            
                            // Sumar al acumulado solo si está pendiente
                            if (!isPaid) {
                                runningAccumulator += remaining;
                            }
                            
                            contentHTML += `
                                <tr>
                                    <td>${item.payee} <br/><span style="color:#666;font-size:9px">${details}</span></td>
                                    <td class="date">${new Date(item.dueDate+'T00:00:00').toLocaleDateString('es-AR')}</td>
                                    <td class="amount">${formatMoney(item.amount)}</td>
                                    <td class="amount ${isPaid ? 'green' : 'red'}">${isPaid ? 'PAGADO' : formatMoney(remaining)}</td>
                                    <td class="amount" style="color:#555;font-weight:bold">${formatMoney(runningAccumulator)}</td>
                                </tr>
                            `;
                        });
                    });
                    contentHTML += `</tbody></table>`;
                }

                contentHTML += `</body></html>`;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(contentHTML);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
            };

            const requestNotify = () => {
                if (typeof Notification === 'undefined') { alert("Tu navegador no soporta notificaciones."); return; }
                Notification.requestPermission().then(perm => { setNotifPermission(perm); if(perm === 'granted') { try { new Notification("SII PALLETS APP", { body: "¡Notificaciones activadas!" }); } catch(e) {} } });
            };

            const checkAlerts = (allItems) => {
                if(typeof Notification === 'undefined' || Notification.permission !== 'granted') return;
                const urgentCount = allItems.filter(c => c.status !== 'paid' && getDays(c.dueDate) <= 5 && getDays(c.dueDate) >= 0).length;
            };

            const alerts = useMemo(() => {
                const all = [...payItems, ...collectItems];
                return all.filter(item => { if (item.status === 'paid') return false; const d = getDays(item.dueDate); return d <= 10; }).sort((a,b) => getDays(a.dueDate) - getDays(b.dueDate));
            }, [payItems, collectItems]);

            const balanceData = useMemo(() => {
                const pendingPay = payItems.filter(i => i.status !== 'paid').reduce((sum, i) => sum + (i.amount - (i.paidAmount || 0)), 0);
                const pendingCollect = collectItems.filter(i => i.status !== 'paid').reduce((sum, i) => sum + (i.amount - (i.paidAmount || 0)), 0);
                const expensesByCategory = {};
                payItems.filter(i => i.status !== 'paid').forEach(item => {
                    const cat = item.category || 'others';
                    if (!expensesByCategory[cat]) expensesByCategory[cat] = 0;
                    expensesByCategory[cat] += (item.amount - (item.paidAmount || 0));
                });
                const sortedCategories = Object.entries(expensesByCategory).sort(([,a], [,b]) => b - a).map(([cat, amount]) => ({ cat, amount }));
                let dailyAgenda = [];
                if (mode === 'balance') {
                    const dates = new Set();
                    [...payItems, ...collectItems].filter(i => i.status !== 'paid').forEach(i => { if(i.dueDate) dates.add(i.dueDate); });
                    const sortedDates = Array.from(dates).sort((a,b) => new Date(a) - new Date(b));
                    dailyAgenda = sortedDates.map(date => {
                        const dayPays = payItems.filter(i => i.dueDate === date && i.status !== 'paid');
                        const dayCollects = collectItems.filter(i => i.dueDate === date && i.status !== 'paid');
                        const outflow = dayPays.reduce((s, i) => s + (i.amount - (i.paidAmount||0)), 0);
                        const inflow = dayCollects.reduce((s, i) => s + (i.amount - (i.paidAmount||0)), 0);
                        return { date, outflow, inflow, net: inflow - outflow };
                    });
                }
                return { pay: pendingPay, collect: pendingCollect, net: pendingCollect - pendingPay, dailyAgenda, sortedCategories };
            }, [payItems, collectItems, mode]);

            // --- NUEVO: PREVISIÓN A 15 DÍAS ---
            const forecastData = useMemo(() => {
                const days = [];
                const today = new Date();
                today.setHours(0,0,0,0);
                
                // Generar los próximos 15 días
                for (let i = 0; i < 15; i++) {
                    const current = new Date(today);
                    current.setDate(today.getDate() + i);
                    
                    // Formato manual YYYY-MM-DD para evitar problemas de zona horaria
                    const year = current.getFullYear();
                    const month = String(current.getMonth() + 1).padStart(2, '0');
                    const day = String(current.getDate()).padStart(2, '0');
                    const dateKey = `${year}-${month}-${day}`;

                    const dayPays = payItems.filter(item => item.dueDate === dateKey && item.status !== 'paid');
                    const dayCollects = collectItems.filter(item => item.dueDate === dateKey && item.status !== 'paid');

                    const outflow = dayPays.reduce((sum, item) => sum + (item.amount - (item.paidAmount || 0)), 0);
                    const inflow = dayCollects.reduce((sum, item) => sum + (item.amount - (item.paidAmount || 0)), 0);
                    const net = inflow - outflow;
                    
                    days.push({ date: current, dateKey, net, inflow, outflow });
                }
                return days;
            }, [payItems, collectItems]);

            const dashboardData = useMemo(() => {
                const currentItems = mode === 'pay' ? payItems : (mode === 'collect' ? collectItems : []);
                const pending = currentItems.filter(i => i.status !== 'paid');
                const calcDebt = (list) => list.reduce((s, i) => s + (i.amount - (i.paidAmount || 0)), 0);
                return {
                    expired: { count: pending.filter(i => getDays(i.dueDate) < 0).length, total: calcDebt(pending.filter(i => getDays(i.dueDate) < 0)) },
                    urgent: { count: pending.filter(i => getDays(i.dueDate) >= 0 && getDays(i.dueDate) <= 7).length, total: calcDebt(pending.filter(i => getDays(i.dueDate) >= 0 && getDays(i.dueDate) <= 7)) },
                    future: { count: pending.filter(i => getDays(i.dueDate) > 7).length, total: calcDebt(pending.filter(i => getDays(i.dueDate) > 7)) }
                };
            }, [payItems, collectItems, mode]);

            const groupedView = useMemo(() => {
                if (mode === 'balance') return null;
                let items = mode === 'pay' ? payItems : collectItems;
                
                if (searchTerm) {
                    const lowerSearch = searchTerm.toLowerCase();
                    items = items.filter(i => (i.payee && i.payee.toLowerCase().includes(lowerSearch)) || (i.number && i.number.toLowerCase().includes(lowerSearch)));
                }

                // NUEVO: FILTRO POR FECHA ESPECÍFICA (DESDE CALENDARIO)
                if (selectedDateFilter) {
                    items = items.filter(i => i.dueDate === selectedDateFilter);
                } else if (activeFilter !== 'all') {
                     // Solo aplicar filtros de estado si no hay filtro de fecha
                    items = items.filter(i => {
                        if (i.status === 'paid') return false;
                        const d = getDays(i.dueDate);
                        if (activeFilter === 'expired') return d < 0;
                        if (activeFilter === 'urgent') return d >= 0 && d <= 7;
                        if (activeFilter === 'future') return d > 7;
                        return true;
                    });
                }

                let filtered = items;

                if (mode === 'collect') {
                    const groups = {};
                    filtered.forEach(item => {
                        const clientName = item.payee ? item.payee.trim().toUpperCase() : 'SIN NOMBRE';
                        if (!groups[clientName]) groups[clientName] = { key: clientName, label: item.payee, total: 0, items: [], count: 0 };
                        const pendingAmount = item.amount - (item.paidAmount || 0);
                        if (item.status !== 'paid') groups[clientName].total += pendingAmount;
                        groups[clientName].count += 1;
                        groups[clientName].items.push(item);
                    });
                    return { type: 'client-grouped', data: Object.values(groups).sort((a,b) => b.total - a.total) };
                } else {
                    filtered.sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
                    if (activeFilter === 'all' && !selectedDateFilter) return { type: 'flat', data: filtered };
                    const groups = {};
                    filtered.forEach(item => {
                        const dateKey = item.dueDate;
                        if (!dateKey) return;
                        if (!groups[dateKey]) groups[dateKey] = { key: dateKey, total: 0, items: [] };
                        groups[dateKey].total += (item.amount - (item.paidAmount || 0)); 
                        groups[dateKey].items.push(item);
                    });
                    return { type: 'date-grouped', data: Object.values(groups).sort((a,b) => new Date(a.key) - new Date(b.key)) };
                }
            }, [payItems, collectItems, activeFilter, mode, searchTerm, selectedDateFilter]);

            const handleAdd = async (e) => {
                e.preventDefault();
                const targetCollection = mode === 'collect' ? 'cobros_public_shared' : 'cheques_public_shared';
                const itemData = {
                    number: newItem.number, issueDate: newItem.issueDate, dueDate: newItem.dueDate, amount: parseFloat(newItem.amount), payee: newItem.payee,
                    paidAmount: newItem.paidAmount || 0, subtype: newItem.subtype || 'cheque', category: newItem.category || 'others', status: newItem.status || 'pending'
                };
                if (editingId) { await updateDoc(doc(db, targetCollection, 'main_list', 'items', editingId), itemData); } 
                else { await addDoc(collection(db, targetCollection, 'main_list', 'items'), { ...itemData, createdAt: new Date().toISOString() }); }
                setNewItem({ number: '', issueDate: '', dueDate: '', amount: '', payee: '', paidAmount: 0, subtype: 'cheque', category: 'others', status: 'pending' });
                setEditingId(null);
                setShowAddForm(false);
            };

            const handleEdit = (item) => {
                setNewItem({
                    number: item.number || '', issueDate: item.issueDate || '', dueDate: item.dueDate || '', amount: item.amount, payee: item.payee,
                    paidAmount: item.paidAmount || 0, subtype: item.subtype || 'cheque', category: item.category || 'others', status: item.status || 'pending'
                });
                setEditingId(item.id);
                setShowAddForm(true);
            };

            const markFullPayment = async (item) => {
                const collectionName = item.type === 'collect' ? 'cobros_public_shared' : 'cheques_public_shared';
                const newStatus = item.status === 'paid' ? 'pending' : 'paid';
                const newPaidAmount = newStatus === 'paid' ? item.amount : 0;
                await updateDoc(doc(db, collectionName, 'main_list', 'items', item.id), { status: newStatus, paidAmount: newPaidAmount });
            };

            const markPartialPayment = async (item) => {
                const amountStr = prompt(`Total: ${item.amount}\nPagado: ${item.paidAmount || 0}\n\nNuevo total acumulado:`);
                if(!amountStr) return;
                const totalPaid = parseFloat(amountStr);
                if(isNaN(totalPaid)) return alert("Inválido");
                let newStatus = 'pending';
                if(totalPaid >= item.amount) newStatus = 'paid';
                else if(totalPaid > 0) newStatus = 'partial';
                const collectionName = item.type === 'collect' ? 'cobros_public_shared' : 'cheques_public_shared';
                await updateDoc(doc(db, collectionName, 'main_list', 'items', item.id), { status: newStatus, paidAmount: totalPaid >= item.amount ? item.amount : totalPaid });
            };

            const deleteItem = async (item) => {
                if(!confirm('¿Eliminar?')) return;
                const collectionName = item.type === 'collect' ? 'cobros_public_shared' : 'cheques_public_shared';
                await deleteDoc(doc(db, collectionName, 'main_list', 'items', item.id));
            };

            const installApp = () => {
                if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then((res) => { if(res.outcome==='accepted') setDeferredPrompt(null); }); }
            };

            const getTypeIcon = (subtype) => {
                switch(subtype) {
                    case 'transfer': return <IconBank className="w-4 h-4"/>;
                    case 'cash': return <IconCash className="w-4 h-4"/>;
                    case 'fixed': case 'salary': return <IconBuilding className="w-4 h-4"/>;
                    default: return <span className="font-mono text-[10px] border px-1 rounded bg-white">CHQ</span>;
                }
            };

            const getTheme = () => {
                if(mode === 'pay') return { main: 'blue', bg: 'bg-blue-800', light: 'bg-blue-50', text: 'text-blue-600', border: 'border-blue-500', btn: 'bg-blue-600' };
                if(mode === 'collect') return { main: 'emerald', bg: 'bg-emerald-800', light: 'bg-emerald-50', text: 'text-emerald-600', border: 'border-emerald-500', btn: 'bg-emerald-600' };
                return { main: 'violet', bg: 'bg-violet-900', light: 'bg-violet-50', text: 'text-violet-600', border: 'border-violet-500', btn: 'bg-violet-600' }; 
            }
            const theme = getTheme();

            if (loading && payItems.length === 0 && collectItems.length === 0) return <div className="h-screen flex items-center justify-center"><IconLoader className={`animate-spin w-10 h-10 ${theme.text}`}/></div>;

            return (
                <div className="pb-24 max-w-4xl mx-auto min-h-screen bg-gray-50 shadow-2xl relative transition-colors duration-500">
                    <div className={`${theme.bg} text-white p-4 sticky top-0 z-30 shadow-lg transition-colors duration-500`}>
                        <div className="flex justify-between items-center mb-4">
                            <h1 className="text-xl font-bold flex items-center gap-2">SII PALLETS APP</h1>
                            <div className="flex gap-2 items-center">
                                {deferredPrompt && ( <button onClick={installApp} className="bg-white/20 hover:bg-white/30 px-2 py-1 rounded text-xs font-bold flex items-center gap-1"><IconDownload className="w-4 h-4" /> Instalar</button> )}
                                <button onClick={printReport} className="p-2 relative bg-white/20 rounded-full hover:bg-white/30" title="Imprimir Reporte PDF"><IconPrinter className="w-5 h-5"/></button>
                                <div className="relative">
                                    <button onClick={() => setShowNotifPanel(!showNotifPanel)} className="p-2 relative">
                                        {alerts.length > 0 ? <IconBellRing className="w-6 h-6 animate-pulse text-yellow-300"/> : <IconBell className="w-6 h-6"/>}
                                        {alerts.length > 0 && <span className="absolute top-1 right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 rounded-full">{alerts.length}</span>}
                                    </button>
                                    {showNotifPanel && (
                                        <div className="absolute right-0 mt-3 w-72 bg-white text-gray-800 rounded-xl shadow-2xl border border-gray-200 z-50 overflow-hidden">
                                            <div className="p-3 bg-gray-50 border-b flex justify-between items-center"><h3 className="font-bold text-sm">Alertas (10 días)</h3>{notifPermission !== 'granted' && <button onClick={requestNotify} className="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold hover:bg-blue-200">ACTIVAR PUSH</button>}</div>
                                            <div className="max-h-60 overflow-y-auto">
                                                {alerts.length === 0 ? <div className="p-4 text-center text-xs text-gray-400">Todo tranquilo.</div> :
                                                alerts.map(a => {
                                                    const d = getDays(a.dueDate);
                                                    const isPay = a.type === 'pay';
                                                    return (
                                                        <div key={a.id} className={`p-3 border-b text-sm ${d < 0 ? 'bg-red-50' : 'bg-white'}`}>
                                                            <div className="flex justify-between"><span className={`text-[10px] font-bold px-1 rounded ${isPay ? 'bg-blue-100 text-blue-700' : 'bg-emerald-100 text-emerald-700'}`}>{isPay ? 'PAGO' : 'COBRO'}</span><span className="font-mono text-xs">{formatMoney(a.amount - (a.paidAmount||0))}</span></div>
                                                            <p className="font-bold mt-1">{a.payee}</p>
                                                            <p className={`text-xs ${d < 0 ? 'text-red-600 font-bold' : 'text-orange-500'}`}>{d < 0 ? `Vencido hace ${Math.abs(d)} días` : `Vence en ${d} días`}</p>
                                                        </div>
                                                    )
                                                })}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="mb-3 relative">
                            <input type="text" placeholder="Buscar por nombre, cheque o factura..." className="w-full pl-9 pr-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/70 outline-none focus:bg-white/30 text-sm" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                            <IconSearch className="w-4 h-4 text-white/70 absolute left-3 top-2.5"/>
                        </div>

                        <div className="bg-black/20 p-1 rounded-xl flex relative text-[10px] sm:text-xs">
                            <button onClick={() => { setMode('pay'); setActiveFilter('all'); setSelectedDateFilter(null); }} className={`flex-1 py-2 rounded-lg font-bold flex flex-col sm:flex-row items-center justify-center gap-1 transition-all ${mode === 'pay' ? 'bg-white text-blue-800 shadow-md' : 'text-white/60'}`}><IconWallet className="w-4 h-4"/> <span>PAGOS</span></button>
                            <button onClick={() => { setMode('balance'); setSelectedDateFilter(null); }} className={`flex-1 py-2 rounded-lg font-bold flex flex-col sm:flex-row items-center justify-center gap-1 transition-all ${mode === 'balance' ? 'bg-white text-violet-800 shadow-md' : 'text-white/60'}`}><IconTrendingUp className="w-4 h-4"/> <span>BALANCE</span></button>
                            <button onClick={() => { setMode('collect'); setActiveFilter('all'); setSelectedDateFilter(null); }} className={`flex-1 py-2 rounded-lg font-bold flex flex-col sm:flex-row items-center justify-center gap-1 transition-all ${mode === 'collect' ? 'bg-white text-emerald-800 shadow-md' : 'text-white/60'}`}><IconBriefcase className="w-4 h-4"/> <span>COBROS</span></button>
                        </div>
                    </div>

                    <div className="p-4">
                        {mode === 'balance' && (
                            <div className="animate-fade-in">
                                <div className={`bg-white p-5 rounded-2xl shadow-md border-l-8 mb-6 border-violet-500`}>
                                    <p className="text-xs font-bold text-gray-400 uppercase tracking-wide mb-3">Estado Financiero Global (Pendiente)</p>
                                    <div className="flex justify-between text-center mb-4">
                                        <div><p className="text-xs text-emerald-600 font-bold mb-1">A COBRAR</p><p className="text-xl font-bold text-gray-800">{formatMoney(balanceData.collect)}</p></div>
                                        <div><p className="text-xs text-blue-600 font-bold mb-1">A PAGAR</p><p className="text-xl font-bold text-gray-800">{formatMoney(balanceData.pay)}</p></div>
                                    </div>
                                    <div className="border-t pt-3 flex justify-between items-center"><span className="text-sm font-bold text-gray-600">PROYECCIÓN SALDO:</span><span className={`text-3xl font-black ${balanceData.net >= 0 ? 'text-emerald-500' : 'text-red-500'}`}>{balanceData.net > 0 ? '+' : ''}{formatMoney(balanceData.net)}</span></div>
                                </div>
                                
                                {/* NUEVO: PROYECCIÓN A 15 DÍAS (CUADRÍCULA 5x3) */}
                                <div className="mb-6">
                                    <h3 className="font-bold text-gray-700 mb-3 ml-1 flex items-center gap-2"><IconCalendar className="w-5 h-5 text-violet-600"/> Proyección 15 Días</h3>
                                    
                                    <div className="grid grid-cols-3 sm:grid-cols-5 gap-2">
                                        {forecastData.map((day, idx) => (
                                            <button 
                                                key={idx} 
                                                onClick={() => {
                                                    // Ir al modo que corresponda si hay datos, o quedarse en balance para ver detalles si quisiera (pero la lista está abajo en modo pago/cobro)
                                                    // Mejor: Filtrar la lista actual (si estuviera visible) o ir a modo PAGOS filtrado por esa fecha si es salida, o COBROS si es entrada.
                                                    // Para simplificar y ser útil: Al hacer click, vamos al modo "PAGOS" (o el que tenga más movimiento) y filtramos por esa fecha.
                                                    const targetMode = day.outflow > day.inflow ? 'pay' : 'collect';
                                                    setMode(targetMode);
                                                    setSelectedDateFilter(day.dateKey);
                                                }}
                                                className={`p-2 rounded-xl border flex flex-col items-center justify-center shadow-sm transition-transform active:scale-95 ${day.net > 0 ? 'bg-emerald-50 border-emerald-200' : (day.net < 0 ? 'bg-red-50 border-red-200' : 'bg-white border-gray-100')}`}
                                            >
                                                <span className="text-[10px] font-bold text-gray-500 uppercase mb-1">{day.date.toLocaleDateString('es-AR', {weekday:'short', day:'numeric'})}</span>
                                                <span className={`text-xs font-black ${day.net > 0 ? 'text-emerald-600' : (day.net < 0 ? 'text-red-600' : 'text-gray-300')}`}>
                                                    {day.net === 0 ? '-' : (day.net > 0 ? '+' : '') + formatMoney(Math.abs(day.net))}
                                                </span>
                                                {(day.inflow > 0 || day.outflow > 0) && (
                                                    <div className="flex gap-1 mt-1 justify-center w-full">
                                                        {day.inflow > 0 && <div className="w-1.5 h-1.5 rounded-full bg-emerald-400"></div>}
                                                        {day.outflow > 0 && <div className="w-1.5 h-1.5 rounded-full bg-blue-400"></div>}
                                                    </div>
                                                )}
                                            </button>
                                        ))}
                                    </div>
                                    <p className="text-[10px] text-gray-400 mt-2 text-center">Toca un día para ver el detalle de movimientos.</p>
                                </div>

                                {balanceData.sortedCategories.length > 0 && (
                                    <div className="bg-white p-5 rounded-2xl shadow-md border border-gray-100 mb-6">
                                        <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2 text-sm uppercase tracking-wide">
                                            <IconPieChart className="w-4 h-4 text-blue-500"/> Distribución de Gastos (Pendientes)
                                        </h3>
                                        <div className="space-y-3">
                                            {balanceData.sortedCategories.map((item, idx) => {
                                                const percent = balanceData.pay > 0 ? (item.amount / balanceData.pay) * 100 : 0;
                                                const isExpanded = expandedCategory === item.cat;
                                                return (
                                                    <div key={idx} className="mb-3">
                                                        <button onClick={() => setExpandedCategory(isExpanded ? null : item.cat)} className="w-full text-left">
                                                            <div className="flex justify-between text-xs mb-1">
                                                                <span className="font-bold text-gray-600 flex items-center gap-1">{getCategoryLabel(item.cat)} <IconChevronDown className={`w-3 h-3 text-gray-400 transition-transform ${isExpanded ? 'rotate-180' : ''}`}/></span>
                                                                <span className="font-mono text-gray-500">{formatMoney(item.amount)}</span>
                                                            </div>
                                                            <div className="w-full bg-gray-100 rounded-full h-2.5"><div className={`h-2.5 rounded-full ${getCategoryColor(item.cat)}`} style={{ width: `${percent}%` }}></div></div>
                                                        </button>
                                                        {isExpanded && (
                                                            <div className="mt-2 pl-2 border-l-2 border-gray-200 space-y-2 animate-fade-in">
                                                                {payItems.filter(p => p.status !== 'paid' && (p.category || 'others') === item.cat).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)).map(detail => (
                                                                        <div key={detail.id} className="text-xs flex justify-between bg-gray-50 p-2 rounded items-center">
                                                                            <span className="truncate pr-2">{detail.payee} <span className="text-gray-400">({new Date(detail.dueDate+'T00:00:00').toLocaleDateString('es-AR', {day:'numeric', month:'short'})})</span></span>
                                                                            <span className="font-mono font-bold whitespace-nowrap">{formatMoney(detail.amount - (detail.paidAmount||0))}</span>
                                                                        </div>
                                                                    ))
                                                                }
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {mode !== 'balance' && (
                            <div className="animate-fade-in">
                                <div className={`bg-white p-5 rounded-2xl shadow-md border-l-8 mb-6 flex items-center justify-between ${theme.border}`}>
                                    <div>
                                        <p className={`text-xs font-bold uppercase tracking-wide mb-1 ${theme.text}`}>
                                            {selectedDateFilter 
                                                ? `Movimientos del ${new Date(selectedDateFilter+'T00:00:00').toLocaleDateString('es-AR')}`
                                                : (mode === 'pay' ? 'Deuda Total Pendiente' : 'Cobros Totales Pendientes')
                                            }
                                        </p>
                                        <p className="text-3xl font-black text-gray-800">{mode === 'pay' ? formatMoney(balanceData.pay) : formatMoney(balanceData.collect)}</p>
                                    </div>
                                    <div className={`${theme.light} p-3 rounded-full`}>{mode === 'pay' ? <IconWallet className={`w-8 h-8 ${theme.text}`} /> : <IconCash className={`w-8 h-8 ${theme.text}`} />}</div>
                                </div>

                                {selectedDateFilter && (
                                    <div className="mb-4 flex justify-between items-center bg-blue-50 p-3 rounded-lg border border-blue-100">
                                        <span className="text-sm text-blue-800 font-bold">📅 Filtrado por fecha: {new Date(selectedDateFilter+'T00:00:00').toLocaleDateString('es-AR')}</span>
                                        <button onClick={() => setSelectedDateFilter(null)} className="text-xs text-red-500 font-bold underline">Borrar Filtro</button>
                                    </div>
                                )}

                                {!selectedDateFilter && (
                                    <div className="grid grid-cols-3 gap-2 mb-6">
                                        {[{ id: 'expired', label: 'Vencidos', color: 'red', data: dashboardData.expired }, { id: 'urgent', label: 'Esta Semana', color: 'orange', data: dashboardData.urgent }, { id: 'future', label: 'A Futuro', color: 'green', data: dashboardData.future }].map(filter => (
                                            <button key={filter.id} onClick={() => setActiveFilter(activeFilter === filter.id ? 'all' : filter.id)} className={`p-2 rounded-xl border-2 transition-all text-center flex flex-col items-center justify-center shadow-sm relative ${activeFilter === filter.id ? `bg-${filter.color}-50 border-${filter.color}-500 ring-2 ring-${filter.color}-200` : 'bg-white border-transparent hover:bg-gray-50'}`}>
                                                <span className={`text-[10px] font-bold text-${filter.color}-600 uppercase`}>{filter.label}</span>
                                                <span className="text-lg font-black text-gray-800 leading-tight">{filter.data.count}</span>
                                                <span className="text-[9px] text-gray-500 truncate w-full">{formatMoney(filter.data.total)}</span>
                                                {activeFilter === filter.id && <div className={`absolute -bottom-2 w-3 h-3 bg-${filter.color}-500 rotate-45 border-r border-b border-white`}></div>}
                                            </button>
                                        ))}
                                    </div>
                                )}

                                <button onClick={() => { setEditingId(null); setNewItem({ number: '', issueDate: '', dueDate: '', amount: '', payee: '', paidAmount: 0, subtype: 'cheque', category: 'others', status: 'pending' }); setShowAddForm(!showAddForm); }} className={`w-full ${theme.btn} hover:opacity-90 text-white p-3 rounded-xl shadow-md mb-6 flex items-center justify-center gap-2 font-bold transition-all active:scale-95`}>
                                    <IconPlus className="w-5 h-5"/> {showAddForm ? 'Cancelar' : (mode === 'pay' ? 'Registrar Pago' : 'Registrar Factura')}
                                </button>

                                {showAddForm && (
                                    <form onSubmit={handleAdd} className="bg-white p-5 rounded-xl shadow-lg border border-gray-200 mb-6 animate-fade-in relative overflow-hidden">
                                        <div className={`absolute top-0 left-0 w-1 h-full ${theme.bg}`}></div>
                                        <h3 className="font-bold mb-4 text-gray-700">{editingId ? 'Editar Movimiento' : (mode === 'pay' ? 'Nuevo Pago (Salida)' : 'Nueva Factura (Entrada)')}</h3>
                                        <div className="space-y-3">
                                            {mode === 'pay' && (
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label className="text-xs text-gray-500 block mb-1">Tipo</label>
                                                        <select className="w-full p-3 bg-gray-50 rounded-lg border text-sm outline-none text-gray-700" value={newItem.subtype} onChange={e => setNewItem({...newItem, subtype: e.target.value})}>
                                                            <option value="cheque">🎫 Cheque</option>
                                                            <option value="transfer">🏦 Transferencia</option>
                                                            <option value="cash">💵 Efectivo</option>
                                                            <option value="fixed">🏢 Gasto Fijo</option>
                                                            <option value="salary">👥 Sueldo</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="text-xs text-gray-500 block mb-1">Categoría</label>
                                                        <select className="w-full p-3 bg-gray-50 rounded-lg border text-sm outline-none text-gray-700" value={newItem.category} onChange={e => setNewItem({...newItem, category: e.target.value})}>
                                                            <option value="others">Otros</option>
                                                            <option value="raw">Materia Prima</option>
                                                            <option value="logistics">Logística</option>
                                                            <option value="salaries">RRHH / Sueldos</option>
                                                            <option value="taxes">Impuestos</option>
                                                            <option value="services">Servicios</option>
                                                            <option value="maintenance">Mantenimiento</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            )}

                                            <div>
                                                <input list={mode === 'collect' ? "clientsSuggestions" : ""} className="w-full p-3 bg-gray-50 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none" placeholder={mode === 'pay' ? "Beneficiario (A quién pagas)" : "Cliente"} value={newItem.payee} onChange={e=>setNewItem({...newItem, payee:e.target.value})} required />
                                                {mode === 'collect' && <datalist id="clientsSuggestions">{uniqueClients.map(client => <option key={client} value={client} />)}</datalist>}
                                            </div>

                                            <div className="flex gap-3">
                                                <input 
                                                    className="w-1/2 p-3 bg-gray-50 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none" 
                                                    placeholder={mode === 'collect' ? "Nº Factura" : (newItem.subtype === 'cheque' ? "Nº Cheque" : "Nota / Ref (Opcional)")} 
                                                    value={newItem.number} 
                                                    onChange={e=>setNewItem({...newItem, number:e.target.value})} 
                                                    required={mode === 'collect' || newItem.subtype === 'cheque'}
                                                />
                                                <input type="number" step="0.01" className="w-1/2 p-3 bg-gray-50 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none" placeholder="$ Importe Total" value={newItem.amount} onChange={e=>setNewItem({...newItem, amount:e.target.value})} required />
                                            </div>
                                            <div className="flex gap-3">
                                                <div className="w-1/2"><label className="text-xs text-gray-500 block mb-1">Emisión</label><input type="date" className="w-full p-3 bg-gray-50 rounded-lg border outline-none" value={newItem.issueDate} onChange={e=>setNewItem({...newItem, issueDate:e.target.value})} /></div>
                                                <div className="w-1/2"><label className="text-xs text-gray-500 block mb-1 font-bold">Vencimiento</label><input type="date" className="w-full p-3 bg-gray-50 rounded-lg border outline-none font-bold text-gray-700" value={newItem.dueDate} onChange={e=>setNewItem({...newItem, dueDate:e.target.value})} required /></div>
                                            </div>
                                            <button type="submit" className={`w-full ${theme.btn} text-white p-3 rounded-lg font-bold hover:opacity-90`}>{editingId ? 'Actualizar' : 'Guardar'}</button>
                                        </div>
                                    </form>
                                )}

                                <div className="space-y-3">
                                    <div className="flex justify-between items-end mb-2 border-b pb-2">
                                        <h2 className="text-lg font-bold text-gray-700">{activeFilter === 'all' ? 'Listado' : 'Filtrado'}</h2>
                                        {activeFilter !== 'all' && <button onClick={() => setActiveFilter('all')} className={`text-xs ${theme.text} font-bold underline`}>Ver Todo</button>}
                                    </div>

                                    {(() => {
                                        const renderItem = (item) => {
                                            const days = getDays(item.dueDate);
                                            const isPaid = item.status === 'paid';
                                            const isPartial = item.status === 'partial';
                                            let borderClass = 'border-l-4 ';
                                            if (isPaid) borderClass += 'border-gray-300 bg-gray-50 opacity-60';
                                            else if (isPartial) borderClass += 'border-yellow-400 bg-yellow-50';
                                            else if (days < 0) borderClass += 'border-red-500 bg-red-50';
                                            else if (days <= 7) borderClass += 'border-orange-400 bg-orange-50';
                                            else borderClass += 'border-green-400 bg-white';

                                            return (
                                                <div key={item.id} className={`p-4 rounded-lg shadow-sm flex flex-col sm:flex-row gap-2 justify-between items-start sm:items-center ${borderClass} mb-2 bg-white`}>
                                                    <div className="flex-1 min-w-0">
                                                        <div className="flex items-center gap-2">
                                                            <div className="text-gray-400">{getTypeIcon(item.subtype)}</div>
                                                            <h3 className={`font-bold truncate ${isPaid ? 'line-through text-gray-500' : 'text-gray-800'}`}>{item.payee}</h3>
                                                            {isPartial && <span className="bg-yellow-200 text-yellow-800 text-[9px] px-1 rounded font-bold">PARCIAL</span>}
                                                            {item.type === 'pay' && item.category !== 'others' && <span className={`text-white text-[9px] px-1.5 py-0.5 rounded font-bold uppercase ml-1 ${getCategoryColor(item.category)}`}>{getCategoryLabel(item.category)}</span>}
                                                        </div>
                                                        <div className="text-xs text-gray-500 flex flex-wrap gap-2 mt-1">
                                                            {item.number && <span className="font-mono bg-white px-1 rounded border">#{item.number}</span>}
                                                            <span>•</span>
                                                            <span className={days < 0 && !isPaid ? 'text-red-600 font-bold' : ''}>Vence: {formatDate(item.dueDate)}</span>
                                                        </div>
                                                    </div>
                                                    <div className="w-full sm:w-auto flex justify-between sm:justify-end items-center gap-4 pl-0 sm:pl-3 border-t sm:border-t-0 pt-2 sm:pt-0 mt-2 sm:mt-0">
                                                        <div className="text-right">
                                                            <div className="font-bold text-gray-800">{formatMoney(item.amount)}</div>
                                                            {(isPartial || (isPaid && item.paidAmount < item.amount)) && <div className="text-[10px] text-red-500 font-bold">Resta: {formatMoney(item.amount - (item.paidAmount || 0))}</div>}
                                                        </div>
                                                        <div className="flex gap-1">
                                                            <button onClick={() => markFullPayment(item)} className={`p-1.5 rounded border shadow-sm ${isPaid ? 'bg-green-100 text-green-700 border-green-300' : 'bg-white text-gray-400 hover:text-green-600'}`}><IconCheck className="w-4 h-4"/></button>
                                                            {!isPaid && <button onClick={() => markPartialPayment(item)} className="p-1.5 rounded border shadow-sm bg-white text-gray-400 hover:text-yellow-600 hover:bg-yellow-50"><span className="font-bold text-xs w-4 h-4 flex items-center justify-center">$</span></button>}
                                                            <button onClick={() => {
                                                                const text = item.type === 'pay' 
                                                                    ? `Hola *${item.payee}*, te informo que se generó un PAGO (Ref: ${item.number || 'S/N'}) por *${formatMoney(item.amount)}* con fecha de cobro: ${new Date(item.dueDate+'T00:00:00').toLocaleDateString('es-AR')}. Saludos, SII PALLETS.`
                                                                    : `Hola *${item.payee}*, te recuerdo que la Factura (Ref: ${item.number || 'S/N'}) por *${formatMoney(item.amount)}* vence el día ${new Date(item.dueDate+'T00:00:00').toLocaleDateString('es-AR')}. Saludos, SII PALLETS.`;
                                                                window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
                                                            }} className="p-1.5 rounded border shadow-sm bg-white text-gray-400 hover:text-green-500 hover:bg-green-50 border-gray-200" title="Enviar WhatsApp"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M16.5 16.5 12 12"/></svg></button>
                                                            <button onClick={() => handleEdit(item)} className="p-1.5 rounded border shadow-sm bg-white text-gray-400 hover:text-blue-600 hover:bg-blue-50"><IconPencil className="w-4 h-4"/></button>
                                                            <button onClick={() => deleteItem(item)} className="p-1.5 rounded border shadow-sm bg-white text-gray-400 hover:text-red-600 hover:bg-red-50"><IconTrash className="w-4 h-4"/></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        };

                                        if (!groupedView) return null;
                                        if (groupedView.type === 'flat') {
                                            if(groupedView.data.length === 0) return <div className="text-center py-10 text-gray-400 italic">No hay registros.</div>;
                                            return groupedView.data.map(renderItem);
                                        } else {
                                            if(groupedView.data.length === 0) return <div className="text-center py-10 text-gray-400 italic">No hay registros.</div>;
                                            return groupedView.data.map((group, idx) => {
                                                const isClientGroup = groupedView.type === 'client-grouped';
                                                return (
                                                    <div key={idx} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-2">
                                                        <button onClick={() => setExpandedGroups(p => ({...p, [group.key]: !p[group.key]}))} className="w-full p-3 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition">
                                                            <div className="flex items-center gap-3">
                                                                {isClientGroup ? (<div className={`bg-emerald-100 text-emerald-700 font-bold rounded-full p-2 w-10 h-10 flex items-center justify-center shrink-0`}><IconUserGroup className="w-5 h-5"/></div>) : (<div className={`${theme.light} ${theme.text} font-bold rounded-lg p-2 text-center min-w-[50px]`}><span className="block text-xs uppercase">{new Date(group.key + 'T00:00:00').toLocaleDateString('es-AR', {month:'short'})}</span><span className="block text-xl leading-none">{new Date(group.key + 'T00:00:00').getDate()}</span></div>)}
                                                                <div className="text-left overflow-hidden"><p className="text-sm font-bold text-gray-700 truncate">{isClientGroup ? group.label : `${group.items.length} Items`}</p>{isClientGroup && <p className="text-xs text-gray-500">{group.count} Facturas pendientes</p>}</div>
                                                            </div>
                                                            <div className="text-right shrink-0"><p className="text-lg font-black text-gray-800">{formatMoney(group.total)}</p><IconChevronDown className={`w-5 h-5 ml-auto text-gray-400 transition-transform ${expandedGroups[group.key] ? 'rotate-180' : ''}`} /></div>
                                                        </button>
                                                        {expandedGroups[group.key] && <div className="border-t border-gray-100 animate-fade-in bg-gray-50 p-2 space-y-2">{group.items.map(renderItem)}</div>}
                                                    </div>
                                                );
                                            });
                                        }
                                    })()}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CheqControl />);
    </script>
</body>
</html>

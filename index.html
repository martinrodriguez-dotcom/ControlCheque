<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CheqControl - Gestión de Cheques</title>
    
    <!-- Librerías React y Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // TUS CREDENCIALES
        const firebaseConfig = {
            apiKey: "AIzaSyAuEXUQT99SdJ1YZMhQOU-C0DGjQ1aIWXY",
            authDomain: "controlcheque-19226.firebaseapp.com",
            projectId: "controlcheque-19226",
            storageBucket: "controlcheque-19226.firebasestorage.app",
            messagingSenderId: "659933757076",
            appId: "1:659933757076:web:28d285726e6cb9560fbe81"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const { useState, useEffect, useMemo } = React;

        // Iconos
        const IconBell = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>;
        const IconCheck = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
        const IconTrash = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>;
        const IconPlus = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const IconFilter = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>;
        const IconLoader = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>;

        const CheqControl = () => {
            const [user, setUser] = useState(null);
            const [cheques, setCheques] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeFilter, setActiveFilter] = useState('all'); // 'all', 'expired', 'urgent', 'future'
            const [showAddForm, setShowAddForm] = useState(false);
            const [newCheque, setNewCheque] = useState({ number: '', date: '', amount: '', payee: '' });

            // Autenticación y Carga de Datos
            useEffect(() => {
                signInAnonymously(auth).catch((e) => console.error("Auth Error:", e));
                return onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if(!u) setLoading(false);
                });
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsub = onSnapshot(collection(db, 'cheques_usuarios', user.uid, 'items'), (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    data.sort((a, b) => new Date(a.date) - new Date(b.date));
                    setCheques(data);
                    setLoading(false);
                });
                return () => unsub();
            }, [user]);

            // Utils
            const getDays = (date) => Math.ceil((new Date(date+'T00:00:00') - new Date().setHours(0,0,0,0)) / (86400000));
            const formatMoney = (val) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 }).format(val);

            // Logica de Agrupación (Dashboard)
            const dashboardData = useMemo(() => {
                const pending = cheques.filter(c => c.status === 'pending');
                return {
                    expired: { 
                        count: pending.filter(c => getDays(c.date) < 0).length,
                        total: pending.filter(c => getDays(c.date) < 0).reduce((s, c) => s + c.amount, 0)
                    },
                    urgent: {
                        count: pending.filter(c => getDays(c.date) >= 0 && getDays(c.date) <= 7).length,
                        total: pending.filter(c => getDays(c.date) >= 0 && getDays(c.date) <= 7).reduce((s, c) => s + c.amount, 0)
                    },
                    future: {
                        count: pending.filter(c => getDays(c.date) > 7).length,
                        total: pending.filter(c => getDays(c.date) > 7).reduce((s, c) => s + c.amount, 0)
                    }
                };
            }, [cheques]);

            // Lógica de Filtrado de Lista
            const filteredList = useMemo(() => {
                if (activeFilter === 'all') return cheques;
                return cheques.filter(c => {
                    if (c.status === 'paid') return false; // Filtros solo muestran pendientes
                    const d = getDays(c.date);
                    if (activeFilter === 'expired') return d < 0;
                    if (activeFilter === 'urgent') return d >= 0 && d <= 7;
                    if (activeFilter === 'future') return d > 7;
                    return true;
                });
            }, [cheques, activeFilter]);

            // Acciones
            const handleAdd = async (e) => {
                e.preventDefault();
                if (!user) return;
                await addDoc(collection(db, 'cheques_usuarios', user.uid, 'items'), {
                    ...newCheque, amount: parseFloat(newCheque.amount), status: 'pending', createdAt: new Date().toISOString()
                });
                setNewCheque({ number: '', date: '', amount: '', payee: '' });
                setShowAddForm(false);
            };
            const toggleStatus = async (c) => await updateDoc(doc(db, 'cheques_usuarios', user.uid, 'items', c.id), { status: c.status === 'pending' ? 'paid' : 'pending' });
            const deleteItem = async (id) => confirm('¿Borrar cheque?') && await deleteDoc(doc(db, 'cheques_usuarios', user.uid, 'items', id));

            if (loading) return <div className="h-screen flex items-center justify-center"><IconLoader className="animate-spin text-blue-600 w-8 h-8"/></div>;

            return (
                <div className="pb-20 max-w-4xl mx-auto min-h-screen bg-gray-50 shadow-2xl">
                    {/* Header */}
                    <div className="bg-blue-700 text-white p-4 sticky top-0 z-20 shadow-lg flex justify-between items-center">
                        <h1 className="text-xl font-bold flex items-center gap-2">
                             CheqControl
                        </h1>
                        <div className="text-xs bg-blue-800 px-3 py-1 rounded-full">
                            {cheques.filter(c => c.status === 'pending').length} Pendientes
                        </div>
                    </div>

                    <div className="p-4">
                        {/* DASHBOARD DE RESUMEN (Nueva versión compacta) */}
                        <div className="grid grid-cols-3 gap-2 mb-6">
                            {/* Card 1: Vencidos */}
                            <button 
                                onClick={() => setActiveFilter(activeFilter === 'expired' ? 'all' : 'expired')}
                                className={`p-3 rounded-xl border-2 transition-all text-center flex flex-col items-center justify-center shadow-sm ${activeFilter === 'expired' ? 'bg-red-50 border-red-500 ring-2 ring-red-200' : 'bg-white border-transparent hover:bg-gray-50'}`}
                            >
                                <span className="text-xs font-bold text-red-500 uppercase tracking-wide">Vencidos</span>
                                <span className="text-lg font-black text-gray-800 my-1">{dashboardData.expired.count}</span>
                                <span className="text-[10px] text-gray-500 font-medium truncate w-full">{formatMoney(dashboardData.expired.total)}</span>
                            </button>

                            {/* Card 2: Esta Semana */}
                            <button 
                                onClick={() => setActiveFilter(activeFilter === 'urgent' ? 'all' : 'urgent')}
                                className={`p-3 rounded-xl border-2 transition-all text-center flex flex-col items-center justify-center shadow-sm ${activeFilter === 'urgent' ? 'bg-orange-50 border-orange-500 ring-2 ring-orange-200' : 'bg-white border-transparent hover:bg-gray-50'}`}
                            >
                                <span className="text-xs font-bold text-orange-500 uppercase tracking-wide">Esta Semana</span>
                                <span className="text-lg font-black text-gray-800 my-1">{dashboardData.urgent.count}</span>
                                <span className="text-[10px] text-gray-500 font-medium truncate w-full">{formatMoney(dashboardData.urgent.total)}</span>
                            </button>

                            {/* Card 3: A Futuro */}
                            <button 
                                onClick={() => setActiveFilter(activeFilter === 'future' ? 'all' : 'future')}
                                className={`p-3 rounded-xl border-2 transition-all text-center flex flex-col items-center justify-center shadow-sm ${activeFilter === 'future' ? 'bg-green-50 border-green-500 ring-2 ring-green-200' : 'bg-white border-transparent hover:bg-gray-50'}`}
                            >
                                <span className="text-xs font-bold text-green-600 uppercase tracking-wide">A Futuro</span>
                                <span className="text-lg font-black text-gray-800 my-1">{dashboardData.future.count}</span>
                                <span className="text-[10px] text-gray-500 font-medium truncate w-full">{formatMoney(dashboardData.future.total)}</span>
                            </button>
                        </div>

                        {/* Botón Agregar */}
                        <button 
                            onClick={() => setShowAddForm(!showAddForm)}
                            className="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-xl shadow-lg mb-6 flex items-center justify-center gap-2 font-bold transition-transform active:scale-95"
                        >
                            <IconPlus className="w-5 h-5"/> {showAddForm ? 'Cancelar' : 'Registrar Nuevo Cheque'}
                        </button>

                        {/* Formulario */}
                        {showAddForm && (
                            <form onSubmit={handleAdd} className="bg-white p-5 rounded-xl shadow-lg border border-blue-100 mb-6 animate-fade-in">
                                <div className="space-y-3">
                                    <input className="w-full p-3 bg-gray-50 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Beneficiario (ej: Distribuidora)" value={newCheque.payee} onChange={e=>setNewCheque({...newCheque, payee:e.target.value})} required />
                                    <div className="flex gap-3">
                                        <input className="w-1/2 p-3 bg-gray-50 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nº Cheque" value={newCheque.number} onChange={e=>setNewCheque({...newCheque, number:e.target.value})} required />
                                        <input type="number" step="0.01" className="w-1/2 p-3 bg-gray-50 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none" placeholder="$ Valor" value={newCheque.amount} onChange={e=>setNewCheque({...newCheque, amount:e.target.value})} required />
                                    </div>
                                    <input type="date" className="w-full p-3 bg-gray-50 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none" value={newCheque.date} onChange={e=>setNewCheque({...newCheque, date:e.target.value})} required />
                                    <button type="submit" className="w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700">Guardar Cheque</button>
                                </div>
                            </form>
                        )}

                        {/* Título de Lista */}
                        <div className="flex justify-between items-end mb-3 border-b pb-2">
                            <h2 className="text-lg font-bold text-gray-700">
                                {activeFilter === 'all' && 'Todos los Cheques'}
                                {activeFilter === 'expired' && <span className="text-red-600">Cheques Vencidos</span>}
                                {activeFilter === 'urgent' && <span className="text-orange-500">Vencen Esta Semana</span>}
                                {activeFilter === 'future' && <span className="text-green-600">Pagos Futuros</span>}
                            </h2>
                            {activeFilter !== 'all' && <button onClick={() => setActiveFilter('all')} className="text-xs text-blue-500 font-bold underline">Ver Todos</button>}
                        </div>

                        {/* Lista de Cheques */}
                        <div className="space-y-3">
                            {filteredList.length === 0 ? <div className="text-center py-10 text-gray-400 italic">No hay cheques en esta categoría.</div> : 
                             filteredList.map(item => {
                                const days = getDays(item.date);
                                const isPaid = item.status === 'paid';
                                let statusColor = 'bg-white border-l-4 border-gray-300';
                                if (!isPaid) {
                                    if (days < 0) statusColor = 'bg-red-50 border-l-4 border-red-500';
                                    else if (days <= 7) statusColor = 'bg-orange-50 border-l-4 border-orange-400';
                                    else statusColor = 'bg-white border-l-4 border-green-400';
                                } else {
                                    statusColor = 'bg-gray-100 border-l-4 border-gray-300 opacity-60';
                                }

                                return (
                                    <div key={item.id} className={`p-4 rounded-lg shadow-sm flex justify-between items-center ${statusColor}`}>
                                        <div className="flex-1 min-w-0">
                                            <div className="flex items-center gap-2 mb-1">
                                                <h3 className={`font-bold truncate ${isPaid ? 'line-through text-gray-500' : 'text-gray-800'}`}>{item.payee}</h3>
                                                {days < 0 && !isPaid && <span className="text-[10px] bg-red-100 text-red-700 px-1.5 py-0.5 rounded font-bold">VENCIDO</span>}
                                                {days >= 0 && days <= 7 && !isPaid && <span className="text-[10px] bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded font-bold">{days} días</span>}
                                            </div>
                                            <div className="text-xs text-gray-500 flex gap-3">
                                                <span>#{item.number}</span>
                                                <span>•</span>
                                                <span>{new Date(item.date+'T00:00:00').toLocaleDateString('es-AR')}</span>
                                            </div>
                                        </div>
                                        <div className="text-right pl-3">
                                            <div className="font-bold text-gray-800 text-lg">{formatMoney(item.amount)}</div>
                                            <div className="flex justify-end gap-2 mt-1">
                                                <button onClick={() => toggleStatus(item)} className={`p-1.5 rounded ${isPaid ? 'text-green-600 bg-green-200' : 'text-gray-400 bg-gray-100 hover:bg-green-100 hover:text-green-600'}`}>
                                                    <IconCheck className="w-4 h-4"/>
                                                </button>
                                                <button onClick={() => deleteItem(item.id)} className="p-1.5 rounded text-gray-400 bg-gray-100 hover:bg-red-100 hover:text-red-600">
                                                    <IconTrash className="w-4 h-4"/>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CheqControl />);
    </script>
</body>
</html>

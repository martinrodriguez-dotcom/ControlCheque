<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CheqControl - Compartido</title>
    <meta name="theme-color" content="#1e40af">
    
    <!-- Librerías -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .accordion-content { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; overflow: hidden; }
        /* Evitar zoom en inputs en iOS */
        input, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // TUS CREDENCIALES
        const firebaseConfig = {
            apiKey: "AIzaSyAuEXUQT99SdJ1YZMhQOU-C0DGjQ1aIWXY",
            authDomain: "controlcheque-19226.firebaseapp.com",
            projectId: "controlcheque-19226",
            storageBucket: "controlcheque-19226.firebasestorage.app",
            messagingSenderId: "659933757076",
            appId: "1:659933757076:web:28d285726e6cb9560fbe81"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const { useState, useEffect, useMemo } = React;

        // --- ICONOS ---
        const IconCheck = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
        const IconTrash = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>;
        const IconPlus = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const IconLoader = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>;
        const IconChevronDown = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 12 15 18 9"/></svg>;
        const IconBell = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>;
        const IconBellRing = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/><path d="M4 2C2.8 3.7 2 5.7 2 8"/><path d="M22 8c0-2.3-.8-4.3-2-6"/></svg>;

        const CheqControl = () => {
            const [cheques, setCheques] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeFilter, setActiveFilter] = useState('all'); 
            const [showAddForm, setShowAddForm] = useState(false);
            const [newCheque, setNewCheque] = useState({ number: '', date: '', amount: '', payee: '' });
            const [expandedDates, setExpandedDates] = useState({});
            
            // Estado de Notificaciones
            const [showNotifPanel, setShowNotifPanel] = useState(false);
            const [notifPermission, setNotifPermission] = useState(Notification.permission);

            useEffect(() => {
                signInAnonymously(auth);
                // Conexión a la colección COMPARTIDA "shared_list"
                const unsub = onSnapshot(collection(db, 'cheques_public_shared', 'main_list', 'items'), (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    data.sort((a, b) => new Date(a.date) - new Date(b.date));
                    setCheques(data);
                    setLoading(false);
                    
                    // Chequear alertas al cargar datos si hay permiso
                    checkAlerts(data);
                });
                return () => unsub();
            }, []);

            // Helpers
            const getDays = (date) => Math.ceil((new Date(date+'T00:00:00') - new Date().setHours(0,0,0,0)) / (86400000));
            const formatMoney = (val) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 }).format(val);
            const formatDate = (dateStr) => {
                const date = new Date(dateStr + 'T00:00:00');
                return date.toLocaleDateString('es-AR', { weekday: 'short', day: 'numeric', month: 'short' });
            };

            // Notificaciones
            const requestNotify = () => {
                Notification.requestPermission().then(perm => {
                    setNotifPermission(perm);
                    if(perm === 'granted') {
                        new Notification("CheqControl", { body: "¡Notificaciones activadas correctamente!" });
                        checkAlerts(cheques);
                    }
                });
            };

            const checkAlerts = (data) => {
                if(Notification.permission !== 'granted') return;
                
                const urgentCount = data.filter(c => c.status === 'pending' && getDays(c.date) <= 5 && getDays(c.date) >= 0).length;
                const expiredCount = data.filter(c => c.status === 'pending' && getDays(c.date) < 0).length;

                if (urgentCount > 0 || expiredCount > 0) {
                    // Evitamos spam, solo notificamos si la app acaba de abrirse o actualizarse
                    // En una app real usaríamos un flag de "ya notificado hoy"
                    // new Notification("Alertas CheqControl", { body: `Tienes ${urgentCount} cheques urgentes y ${expiredCount} vencidos.` });
                }
            };

            // Dashboard Data
            const dashboardData = useMemo(() => {
                const pending = cheques.filter(c => c.status === 'pending');
                return {
                    expired: { 
                        count: pending.filter(c => getDays(c.date) < 0).length,
                        total: pending.filter(c => getDays(c.date) < 0).reduce((s, c) => s + c.amount, 0)
                    },
                    urgent: {
                        count: pending.filter(c => getDays(c.date) >= 0 && getDays(c.date) <= 7).length,
                        total: pending.filter(c => getDays(c.date) >= 0 && getDays(c.date) <= 7).reduce((s, c) => s + c.amount, 0)
                    },
                    future: {
                        count: pending.filter(c => getDays(c.date) > 7).length,
                        total: pending.filter(c => getDays(c.date) > 7).reduce((s, c) => s + c.amount, 0)
                    }
                };
            }, [cheques]);

            // Alertas para el panel de notificaciones (10 y 5 días)
            const alerts = useMemo(() => {
                return cheques.filter(c => {
                    if (c.status === 'paid') return false;
                    const d = getDays(c.date);
                    return d <= 10; // Vencidos o próximos a vencer (10 dias)
                }).sort((a,b) => getDays(a.date) - getDays(b.date));
            }, [cheques]);

            // Lógica de Filtrado y Agrupación
            const groupedView = useMemo(() => {
                let filtered = cheques;
                if (activeFilter !== 'all') {
                    filtered = cheques.filter(c => {
                        if (c.status === 'paid') return false;
                        const d = getDays(c.date);
                        if (activeFilter === 'expired') return d < 0;
                        if (activeFilter === 'urgent') return d >= 0 && d <= 7;
                        if (activeFilter === 'future') return d > 7;
                        return true;
                    });
                }

                if (activeFilter === 'all') return { type: 'flat', data: filtered };

                const groups = {};
                filtered.forEach(item => {
                    if (!groups[item.date]) groups[item.date] = { date: item.date, total: 0, items: [] };
                    groups[item.date].total += item.amount;
                    groups[item.date].items.push(item);
                });

                const groupArray = Object.values(groups).sort((a,b) => new Date(a.date) - new Date(b.date));
                return { type: 'grouped', data: groupArray };

            }, [cheques, activeFilter]);

            // Acciones Base de Datos
            const handleAdd = async (e) => {
                e.preventDefault();
                await addDoc(collection(db, 'cheques_public_shared', 'main_list', 'items'), {
                    ...newCheque, amount: parseFloat(newCheque.amount), status: 'pending', createdAt: new Date().toISOString()
                });
                setNewCheque({ number: '', date: '', amount: '', payee: '' });
                setShowAddForm(false);
            };
            const toggleStatus = async (c) => await updateDoc(doc(db, 'cheques_public_shared', 'main_list', 'items', c.id), { status: c.status === 'pending' ? 'paid' : 'pending' });
            const deleteItem = async (id) => confirm('¿Borrar cheque para TODOS?') && await deleteDoc(doc(db, 'cheques_public_shared', 'main_list', 'items', id));
            const toggleDateGroup = (date) => setExpandedDates(prev => ({ ...prev, [date]: !prev[date] }));

            if (loading) return <div className="h-screen flex items-center justify-center"><IconLoader className="animate-spin text-blue-600 w-8 h-8"/></div>;

            return (
                <div className="pb-20 max-w-4xl mx-auto min-h-screen bg-gray-50 shadow-2xl relative">
                    
                    {/* Header */}
                    <div className="bg-blue-800 text-white p-4 sticky top-0 z-30 shadow-lg flex justify-between items-center">
                        <div>
                            <h1 className="text-xl font-bold flex items-center gap-2">CheqControl</h1>
                            <p className="text-[10px] opacity-70 flex items-center gap-1"><span className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span> ONLINE (COMPARTIDO)</p>
                        </div>
                        
                        {/* Campanita */}
                        <div className="relative">
                            <button onClick={() => setShowNotifPanel(!showNotifPanel)} className="p-2 relative">
                                {alerts.length > 0 ? <IconBellRing className="w-6 h-6 animate-pulse text-yellow-300"/> : <IconBell className="w-6 h-6"/>}
                                {alerts.length > 0 && <span className="absolute top-1 right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 rounded-full">{alerts.length}</span>}
                            </button>

                            {/* Panel Notificaciones */}
                            {showNotifPanel && (
                                <div className="absolute right-0 mt-3 w-72 bg-white text-gray-800 rounded-xl shadow-2xl border border-gray-200 z-50 overflow-hidden">
                                    <div className="p-3 bg-gray-50 border-b flex justify-between items-center">
                                        <h3 className="font-bold text-sm">Alertas</h3>
                                        {notifPermission !== 'granted' && (
                                            <button onClick={requestNotify} className="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold hover:bg-blue-200">
                                                ACTIVAR PUSH
                                            </button>
                                        )}
                                    </div>
                                    <div className="max-h-60 overflow-y-auto">
                                        {alerts.length === 0 ? <div className="p-4 text-center text-xs text-gray-400">Todo tranquilo.</div> :
                                         alerts.map(a => {
                                            const d = getDays(a.date);
                                            return (
                                                <div key={a.id} className={`p-3 border-b text-sm ${d < 0 ? 'bg-red-50' : 'bg-white'}`}>
                                                    <p className="font-bold">{a.payee}</p>
                                                    <p className={`text-xs ${d < 0 ? 'text-red-600 font-bold' : 'text-orange-500'}`}>
                                                        {d < 0 ? `Vencido hace ${Math.abs(d)} días` : `Vence en ${d} días`}
                                                    </p>
                                                    <p className="text-xs font-mono">{formatMoney(a.amount)}</p>
                                                </div>
                                            )
                                         })}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="p-4">
                        {/* DASHBOARD (Filtros) */}
                        <div className="grid grid-cols-3 gap-2 mb-6">
                            {[
                                { id: 'expired', label: 'Vencidos', color: 'red', data: dashboardData.expired },
                                { id: 'urgent', label: 'Esta Semana', color: 'orange', data: dashboardData.urgent },
                                { id: 'future', label: 'A Futuro', color: 'green', data: dashboardData.future }
                            ].map(filter => (
                                <button 
                                    key={filter.id}
                                    onClick={() => setActiveFilter(activeFilter === filter.id ? 'all' : filter.id)}
                                    className={`p-2 rounded-xl border-2 transition-all text-center flex flex-col items-center justify-center shadow-sm relative ${activeFilter === filter.id ? `bg-${filter.color}-50 border-${filter.color}-500 ring-2 ring-${filter.color}-200` : 'bg-white border-transparent hover:bg-gray-50'}`}
                                >
                                    <span className={`text-[10px] font-bold text-${filter.color}-600 uppercase`}>{filter.label}</span>
                                    <span className="text-lg font-black text-gray-800 leading-tight">{filter.data.count}</span>
                                    <span className="text-[9px] text-gray-500 truncate w-full">{formatMoney(filter.data.total)}</span>
                                    {activeFilter === filter.id && <div className={`absolute -bottom-2 w-3 h-3 bg-${filter.color}-500 rotate-45 border-r border-b border-white`}></div>}
                                </button>
                            ))}
                        </div>

                        {/* Botón Agregar */}
                        <button 
                            onClick={() => setShowAddForm(!showAddForm)}
                            className="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-xl shadow-md mb-6 flex items-center justify-center gap-2 font-bold transition-all active:scale-95"
                        >
                            <IconPlus className="w-5 h-5"/> {showAddForm ? 'Cerrar' : 'Nuevo Cheque'}
                        </button>

                        {/* Formulario */}
                        {showAddForm && (
                            <form onSubmit={handleAdd} className="bg-white p-5 rounded-xl shadow-lg border border-blue-100 mb-6 animate-fade-in">
                                <div className="space-y-3">
                                    <input className="w-full p-3 bg-gray-50 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Beneficiario" value={newCheque.payee} onChange={e=>setNewCheque({...newCheque, payee:e.target.value})} required />
                                    <div className="flex gap-3">
                                        <input className="w-1/2 p-3 bg-gray-50 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nº Cheque" value={newCheque.number} onChange={e=>setNewCheque({...newCheque, number:e.target.value})} required />
                                        <input type="number" step="0.01" className="w-1/2 p-3 bg-gray-50 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none" placeholder="$ Valor" value={newCheque.amount} onChange={e=>setNewCheque({...newCheque, amount:e.target.value})} required />
                                    </div>
                                    <input type="date" className="w-full p-3 bg-gray-50 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none" value={newCheque.date} onChange={e=>setNewCheque({...newCheque, date:e.target.value})} required />
                                    <button type="submit" className="w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700">Guardar (Público)</button>
                                </div>
                            </form>
                        )}

                        {/* TITULO SECCIÓN */}
                        <div className="flex justify-between items-end mb-4 border-b pb-2">
                            <h2 className="text-lg font-bold text-gray-700">
                                {activeFilter === 'all' ? 'Listado Completo' : 
                                 activeFilter === 'future' ? 'Agrupado por Fechas (Futuros)' :
                                 activeFilter === 'urgent' ? 'Agrupado por Fechas (Semana)' : 'Agrupado por Fechas (Vencidos)'}
                            </h2>
                            {activeFilter !== 'all' && <button onClick={() => setActiveFilter('all')} className="text-xs text-blue-500 font-bold underline">Ver Todo</button>}
                        </div>

                        {/* RENDERIZADO DE LISTA */}
                        <div className="space-y-3">
                            
                            {/* VISTA PLANA (Todos) */}
                            {groupedView.type === 'flat' && groupedView.data.map(item => {
                                const days = getDays(item.date);
                                const isPaid = item.status === 'paid';
                                let statusClass = isPaid ? 'border-gray-300 opacity-60 bg-gray-100' : 
                                                  days < 0 ? 'border-red-500 bg-red-50' : 
                                                  days <= 7 ? 'border-orange-400 bg-orange-50' : 'border-green-400 bg-white';
                                
                                return (
                                    <div key={item.id} className={`p-4 rounded-lg shadow-sm flex justify-between items-center border-l-4 ${statusClass}`}>
                                        <div className="flex-1 min-w-0">
                                            <h3 className={`font-bold truncate ${isPaid ? 'line-through text-gray-500' : 'text-gray-800'}`}>{item.payee}</h3>
                                            <div className="text-xs text-gray-500 flex gap-2 mt-1">
                                                <span className="font-mono">#{item.number}</span>
                                                <span>•</span>
                                                <span className={days < 0 && !isPaid ? 'text-red-600 font-bold' : ''}>{formatDate(item.date)}</span>
                                            </div>
                                        </div>
                                        <div className="text-right pl-3">
                                            <div className="font-bold text-gray-800">{formatMoney(item.amount)}</div>
                                            <div className="flex justify-end gap-2 mt-1">
                                                <button onClick={() => toggleStatus(item)} className="p-1.5 rounded text-gray-400 bg-white hover:text-green-600 shadow-sm border"><IconCheck className="w-4 h-4"/></button>
                                                <button onClick={() => deleteItem(item.id)} className="p-1.5 rounded text-gray-400 bg-white hover:text-red-600 shadow-sm border"><IconTrash className="w-4 h-4"/></button>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}

                            {/* VISTA AGRUPADA (Filtros) */}
                            {groupedView.type === 'grouped' && groupedView.data.map((group, idx) => (
                                <div key={idx} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                    <button onClick={() => toggleDateGroup(group.date)} className="w-full p-4 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition">
                                        <div className="flex items-center gap-3">
                                            <div className="bg-blue-100 text-blue-700 font-bold rounded-lg p-2 text-center min-w-[50px]">
                                                <span className="block text-xs uppercase">{new Date(group.date + 'T00:00:00').toLocaleDateString('es-AR', {month:'short'})}</span>
                                                <span className="block text-xl leading-none">{new Date(group.date + 'T00:00:00').getDate()}</span>
                                            </div>
                                            <div className="text-left">
                                                <p className="text-sm font-bold text-gray-700">{group.items.length} Cheques</p>
                                                <p className="text-xs text-gray-500">Vencimiento</p>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-lg font-black text-gray-800">{formatMoney(group.total)}</p>
                                            <IconChevronDown className={`w-5 h-5 ml-auto text-gray-400 transition-transform ${expandedDates[group.date] ? 'rotate-180' : ''}`} />
                                        </div>
                                    </button>
                                    
                                    {expandedDates[group.date] && (
                                        <div className="border-t border-gray-100 animate-fade-in bg-white">
                                            {group.items.map(item => (
                                                <div key={item.id} className="p-3 border-b last:border-0 flex justify-between items-center hover:bg-gray-50 pl-6">
                                                    <div>
                                                        <p className="font-bold text-sm text-gray-800">{item.payee}</p>
                                                        <p className="text-xs text-gray-400 font-mono">#{item.number}</p>
                                                    </div>
                                                    <div className="text-right flex items-center gap-3">
                                                        <span className="font-medium text-sm">{formatMoney(item.amount)}</span>
                                                        <div className="flex gap-1">
                                                            <button onClick={() => toggleStatus(item)} className="p-1 rounded bg-gray-100 hover:text-green-600"><IconCheck className="w-4 h-4"/></button>
                                                            <button onClick={() => deleteItem(item.id)} className="p-1 rounded bg-gray-100 hover:text-red-600"><IconTrash className="w-4 h-4"/></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            ))}

                            {((groupedView.type === 'flat' && groupedView.data.length === 0) || (groupedView.type === 'grouped' && groupedView.data.length === 0)) && (
                                <div className="text-center py-12 text-gray-400 italic">No hay cheques aquí.</div>
                            )}

                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CheqControl />);
    </script>
</body>
</html>
